server {
  listen 80;
  server_name my_domain.com;

  # Logs so you actually see what's happening
  access_log /var/log/nginx/shift-patient-care.access.log;
  error_log  /var/log/nginx/shift-patient-care.error.log info;

  # ---- Proxy Wikimedia "commons" ----
  # /wm/wiki/Special:FilePath/<file>  ->  https://commons.wikimedia.org/wiki/Special:FilePath/<file>
  location ^~ /wm/ {
    access_log /var/log/nginx/shift-patient-care.wm.access.log;
    error_log  /var/log/nginx/shift-patient-care.wm.error.log info;

    proxy_ssl_server_name on;
    proxy_ssl_name commons.wikimedia.org;

    proxy_set_header Host commons.wikimedia.org;
    proxy_set_header User-Agent "ShiftPatientCare/1.0";

    # IMPORTANT: trailing slash strips /wm/ prefix
    proxy_pass https://commons.wikimedia.org/;

    # Range support (seeking)
    proxy_set_header Range $http_range;
    proxy_set_header If-Range $http_if_range;
    proxy_force_ranges on;

    proxy_buffering off;
    proxy_request_buffering off;

    proxy_read_timeout 3600;
    proxy_send_timeout 3600;

    # Rewrite redirect to upload.wikimedia.org back onto your origin
    proxy_redirect https://upload.wikimedia.org/ /wm-upload/;
    proxy_redirect http://upload.wikimedia.org/ /wm-upload/;
    proxy_redirect //upload.wikimedia.org/ /wm-upload/;

    # keep Wikimedia redirects on YOUR origin
    proxy_redirect https://commons.wikimedia.org/ /wm/;
    proxy_redirect http://commons.wikimedia.org/ /wm/;

    # handle relative redirects that start with /wiki or /w
    proxy_redirect /wiki/ /wm/wiki/;
    proxy_redirect /w/ /wm/w/;

    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET,HEAD,OPTIONS" always;
    add_header Access-Control-Allow-Headers "*" always;
    if ($request_method = OPTIONS) { return 204; }
  }

  # ---- Proxy Wikimedia "upload" ----
  # /wm-upload/wikipedia/commons/... -> https://upload.wikimedia.org/wikipedia/commons/...
  location ^~ /wm-upload/ {
    access_log /var/log/nginx/shift-patient-care.wm_upload.access.log;
    error_log  /var/log/nginx/shift-patient-care.wm_upload.error.log info;

    proxy_ssl_server_name on;
    proxy_ssl_name upload.wikimedia.org;

    proxy_set_header Host upload.wikimedia.org;
    proxy_set_header User-Agent "ShiftPatientCare/1.0";

    # IMPORTANT: trailing slash strips /wm-upload/ prefix
    proxy_pass https://upload.wikimedia.org/;

    proxy_set_header Range $http_range;
    proxy_set_header If-Range $http_if_range;
    proxy_force_ranges on;

    proxy_buffering off;
    proxy_request_buffering off;

    proxy_read_timeout 3600;
    proxy_send_timeout 3600;

    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET,HEAD,OPTIONS" always;
    add_header Access-Control-Allow-Headers "*" always;
    if ($request_method = OPTIONS) { return 204; }
  }

  # ---- Your app (Vite on 43173) ----
  location / {
    proxy_pass http://127.0.0.1:43173;

    proxy_http_version 1.1;
    proxy_set_header Host $host;

    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    proxy_read_timeout 3600;
    proxy_send_timeout 3600;
  }
}

